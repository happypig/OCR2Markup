<!-- Generated by SpecStory -->

# [c]implement an Oxygen Add-on(Add-on-UI.jpb) to mark  (2025-06-05 22:20:54)

_**User**_

implement an Oxygen Add-on(Add-on-UI.jpb) to mark up the selected string in opened xml by the prompt of a custom Oxygen AI Positron Action(ref_markup_optV2.json), then you may replace the original string diretly; preview the difference by compare side by side(Add-on-UI-preview.jpb); or just copy the results. You may configure the endpoint by local flask API with key, select model from local Ollama(Add-on-UI-setting.jpb and output of localLlmWIntelGPUV2.ipynb).

please follow the development guide from Oxygen:
https://www.oxygenxml.com/doc/versions/27.1/ug-editor/topics/extending-oxygen.html
https://www.oxygenxml.com/doc/versions/27.1/ug-editor/topics/extend-oxygen-with-plugins.html
https://www.oxygenxml.com/doc/versions/27.1/ug-editor/topics/packing-and-deploying-plugins-as-addons.html
https://www.oxygenxml.com/doc/versions/27.1/ug-editor/dev_guide/introduction-dev-guide.html

---

_**Assistant**_

### [Oxygen-markup-add-on.ipynb](file:///c%3A/Project/OCR/Oxygen-markup-add-on.ipynb)

**Goal:**  
Describe the step-by-step implementation plan for an Oxygen XML Add-on that integrates with the local Flask API (from your LLM notebook) to mark up selected citation strings using the custom AI Positron action, provides a UI for configuration and preview, and allows direct replacement in the XML editor.

**Steps:**
1. **Add-on Structure**: Define the Oxygen Add-on structure (plugin.xml, Java classes, resources).
2. **Action Integration**: Implement an Oxygen editor action that:
    - Gets the selected text in the XML editor.
    - Sends it to the local Flask API (with API key, model selection).
    - Receives the marked-up XML string.
    - Replaces the selection or previews the diff.
3. **UI Components**:
    - **Main UI**: For running the markup and replacing the selection.
    - **Preview UI**: Side-by-side diff of original vs. marked-up string.
    - **Settings UI**: Configure endpoint, API key, and select model (fetch from `/api/models`).
4. **API Communication**: Use Java HTTP client to call the Flask API, handle errors, and parse JSON responses.
5. **Packaging**: Follow Oxygen's plugin/add-on packaging and deployment guide.

Below is the structured XML-based notebook content for the implementation plan.

````xml
<VSCode.Cell language="markdown">
# Oxygen Add-on: AI-Powered Citation Markup

This add-on integrates Oxygen XML Editor with your local LLM Flask API to mark up selected citation strings using custom TEI P5 XML tags, as defined in your `ref_markup_optV2.json` action.

## Implementation Plan

1. **Add-on Structure**
   - Create a new Oxygen plugin project.
   - Define `plugin.xml` with extension points for editor actions and UI panels.
   - Add Java classes for the main action, settings, and preview dialogs.

2. **Editor Action: "AI Citation Markup"**
   - Register an editor action available in the context menu and toolbar.
   - When triggered:
     - Get the current selection from the XML editor.
     - Show a dialog with options: "Transform & Replace", "Preview Diff", "Copy Result".
     - On "Transform & Replace":
       - Send the selected string to the Flask API endpoint (`/ai/chat/completions`) with the appropriate prompt and model.
       - Replace the selection with the marked-up XML from the API response.
     - On "Preview Diff":
       - Show a side-by-side diff (original vs. marked-up) in a dialog.
     - On "Copy Result":
       - Copy the marked-up XML to the clipboard.

3. **Settings UI**
   - Add a settings panel accessible from the add-on menu.
   - Allow configuration of:
     - API endpoint (default: `http://localhost:5000/ai/chat/completions`)
     - API key (stored securely)
     - Model selection (fetch available models from `/api/models`)
   - Save and load settings using Oxygen's preferences API.

4. **API Communication**
   - Use Java HTTP client to POST to the Flask API.
   - Construct the request body according to the OpenAI-compatible format:
     - `messages`: system prompt + user selection.
     - `model`: selected model.
     - `Authorization`: Bearer API key.
   - Parse the JSON response and extract the marked-up XML.
   - Handle errors and show user-friendly messages.

5. **Packaging and Deployment**
   - Package the plugin as an Oxygen add-on (`.oxt`).
   - Include all resources and dependencies.
   - Provide installation instructions for end users.

## References

- [Oxygen Plugin Development Guide](https://www.oxygenxml.com/doc/versions/27.1/ug-editor/dev_guide/introduction-dev-guide.html)
- [Oxygen Add-on Packaging](https://www.oxygenxml.com/doc/versions/27.1/ug-editor/topics/packing-and-deploying-plugins-as-addons.html)
- [Oxygen Editor Actions](https://www.oxygenxml.com/doc/versions/27.1/ug-editor/topics/extend-oxygen-with-plugins.html)
- [Oxygen Preferences API](https://www.oxygenxml.com/doc/versions/27.1/ug-editor/topics/preferences-api.html)

---

**Next Steps:**  
- Scaffold the plugin project and implement the main editor action.
- Add UI dialogs for preview and settings.
- Integrate API calls and handle responses.
</VSCode.Cell>
<VSCode.Cell language="markdown">
## Example: Add-on UI Flow

1. **User selects a citation string in the XML editor.**
2. **User triggers "AI Citation Markup" from the context menu.**
3. **Dialog appears:**
   - Shows the original selection.
   - Options: "Transform & Replace", "Preview Diff", "Copy Result".
4. **On "Transform & Replace":**
   - The add-on sends the selection to the Flask API.
   - Receives the marked-up XML.
   - Replaces the selection in the editor.
5. **On "Preview Diff":**
   - Shows a side-by-side diff (original vs. marked-up).
6. **On "Copy Result":**
   - Copies the marked-up XML to the clipboard.
7. **Settings dialog** allows configuration of endpoint, API key, and model.

---

**Note:**  
- The add-on uses the local Flask API (see `localLlmWIntelGPUV2.ipynb`) for AI-powered markup.
- Model list is fetched dynamically from the API for user selection.
- All communication is secured via API key.

</VSCode.Cell>
````

---

