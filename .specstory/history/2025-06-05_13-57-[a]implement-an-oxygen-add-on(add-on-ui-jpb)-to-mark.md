<!-- Generated by SpecStory -->

# [a]implement an Oxygen Add-on(Add-on-UI.jpb) to mark  (2025-06-05 21:57:00)

_**User**_

implement an Oxygen Add-on(Add-on-UI.jpb) to mark up the selected string in opened xml by the prompt of a custom Oxygen AI Positron Action, then you may replace the original string diretly; preview the difference by compare side by side(Add-on-UI-preview.jpb); or just copy the results. You may configure the endpoint by local flask API with key, select model from local Ollama(Add-on-UI-setting.jpb)

please follow the development guide from Oxygen:
https://www.oxygenxml.com/doc/versions/27.1/ug-editor/topics/extending-oxygen.html
https://www.oxygenxml.com/doc/versions/27.1/ug-editor/topics/extend-oxygen-with-plugins.html
https://www.oxygenxml.com/doc/versions/27.1/ug-editor/topics/packing-and-deploying-plugins-as-addons.html
https://www.oxygenxml.com/doc/versions/27.1/ug-editor/dev_guide/introduction-dev-guide.html

---

_**Assistant**_

Okay, I will provide a more detailed plan for developing the Oxygen XML Add-on, focusing on the Java implementation and UI details, and ensure the local LLM notebook links to this plan.

### [Oxygen-AI-Markup-add-on.ipynb](file:///c%3A/Project/OCR/Oxygen-AI-Markup-add-on.ipynb)

The existing cells will be updated to provide a more detailed implementation plan for the Oxygen Add-on. This includes refining the Java class descriptions, UI interactions, and how to use the AI Positron Enterprise settings and the `ref_markup_optV2.json` prompt.

````xml
<VSCode.Cell id="a60f1728" language="python">
# This cell can be removed or used for Python-based helper scripts for add-on development if needed.
# For now, it will be left empty as the primary focus is the Java add-on.
</VSCode.Cell>
<VSCode.Cell id="96643969" language="markdown">
This notebook details the development plan for an Oxygen XML Add-on. The add-on will integrate with your local LLM service via its Flask API, utilizing Oxygen's AI Positron Assistant Enterprise settings for configuration. It will enable users to select text, get AI-powered markup suggestions based on a custom prompt (like `ref_markup_optV2.json`), preview these suggestions, and then apply or copy them.
</VSCode.Cell>
<VSCode.Cell id="f1061c43" language="xml">
<VSCode.Cell id="f1061c43-cell-0" language="markdown">
# Oxygen XML Add-on for AI-Powered Markup

This notebook outlines the development of an Oxygen XML Add-on that integrates with a local LLM service (via Flask API) to provide AI-powered markup capabilities. The add-on will allow users to:

1.  Trigger an action (e.g., via toolbar button or menu item) when text is selected in an XML editor.
2.  Use a predefined prompt structure (from a configuration file like `c:\Project\OCR\ref_markup_optV2.json`) combined with the selected text.
3.  Send this information to the local LLM service, leveraging settings from Oxygen's AI Positron Enterprise configuration (service address, API key, model).
4.  Display a dialog showing the original selected text alongside the LLM's suggested XML markup.
5.  Allow the user to:
    *   **Apply**: Replace the selected text in the editor with the AI-generated markup.
    *   **Copy**: Copy the AI-generated markup to the clipboard.
    *   **Cancel**: Close the dialog without making changes.

This development will follow Oxygen's guidelines for creating add-ons and plugins.

**References:**
*   [Extending Oxygen XML Editor](https://www.oxygenxml.com/doc/versions/27.1/ug-editor/topics/extending-oxygen.html)
*   [Extend Oxygen XML Editor with Plugins](https://www.oxygenxml.com/doc/versions/27.1/ug-editor/topics/extend-oxygen-with-plugins.html)
*   [Packing and Deploying Plugins as Add-ons](https://www.oxygenxml.com/doc/versions/27.1/ug-editor/topics/packing-and-deploying-plugins-as-addons.html)
*   [Oxygen XML Editor Developer Guide](https://www.oxygenxml.com/doc/versions/27.1/ug-editor/dev_guide/introduction-dev-guide.html)
*   [AI Positron Custom Connector](https://www.oxygenxml.com/doc/ug-addons/topics/ai-positron-custom-connector.html) (for understanding how AI Positron settings are structured, though we directly call our Flask API)
*   `c:\Project\OCR\ref_markup_optV2.json` (for prompt structure)
*   `c:\Project\OCR\localLlmWIntelGPUV2.ipynb` (for the local LLM Flask API details)
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-1" language="markdown">
## 1. Add-on Structure

An Oxygen XML Add-on typically has the following structure:

```
Oxygen-AI-Markup-Add-on/
├── addon.xml                 # Add-on descriptor
├── plugin.xml                # Plugin descriptor (core logic)
├── lib/                      # Folder for JAR dependencies
│   └── custom-ai-markup.jar  # Our plugin's compiled JAR
│   └── json-java.jar         # Example: org.json library for JSON processing
├── icons/                    # Folder for custom icons
│   └── ai_markup_icon.png    # Icon for the toolbar/menu action
└── resources/                # Folder for other resources
    └── ref_markup_optV2.json # Bundled prompt configuration
```

*   **`addon.xml`**: Describes the add-on for Oxygen's add-on manager.
*   **`plugin.xml`**: Defines the plugin's extensions, actions, and entry points.
*   **`lib/custom-ai-markup.jar`**: The compiled Java code containing the add-on's logic.
*   **`lib/json-java.jar`**: Dependency for parsing and creating JSON (or similar, like Jackson/Gson).
*   **`resources/ref_markup_optV2.json`**: The prompt configuration file, bundled with the add-on.
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-2" language="markdown">
## 2. `plugin.xml` Configuration

This file is the heart of the plugin, defining how it integrates with Oxygen.

Key sections:
*   **Plugin Information**: ID, name, version, description, vendor.
*   **Extension Points**:
    *   `ro.sync.exml.plugin.workspace.WorkspaceAccessPluginExtension`: To add custom actions to menus/toolbars and access workspace features.
*   **Libraries**: Specifies the JAR file(s) containing the plugin code and dependencies.
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-3" language="xml">
<!-- plugin.xml example -->
<!DOCTYPE plugin SYSTEM "../plugin.dtd">
<plugin
    id="com.example.oxygen.ai.markup"
    name="AI Markup Assistant (Local LLM)"
    description="Provides AI-powered markup suggestions using a configured local LLM via Flask API."
    version="1.0.0"
    vendor="My Company"
    class="com.example.oxygen.ai.markup.AIMarkupPluginExtension">

    <runtime>
        <library name="lib/custom-ai-markup.jar"/>
        <library name="lib/json-java.jar"/> <!-- Example: org.json for JSON processing -->
    </runtime>

    <extension type="WorkspaceAccessPluginExtension" class="com.example.oxygen.ai.markup.AIMarkupWorkspaceAccessPluginExtension"/>
    
</plugin>
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-4" language="markdown">
## 3. Java Implementation Outline

The core logic will be implemented in Java.

**Project Setup:**
*   Create a Java project.
*   Add `oxygen.jar` (from Oxygen installation directory) and other necessary Oxygen SDK JARs to the project's build path.
*   Add `json-java.jar` (or chosen JSON library) to the project's build path and include it in the `lib` folder of the add-on.

**Key Java Classes:**

1.  **`com.example.oxygen.ai.markup.AIMarkupPluginExtension.java`**:
    *   Implements `ro.sync.exml.plugin.PluginExtension`.
    *   `init(PluginDescriptor descriptor)`: Called when the plugin is initialized.
    *   `applicationClosing()`: Called when Oxygen is closing, for cleanup if needed.

2.  **`com.example.oxygen.ai.markup.AIMarkupWorkspaceAccessPluginExtension.java`**:
    *   Implements `ro.sync.exml.plugin.workspace.WorkspaceAccessPluginExtension`.
    *   `applicationStarted(StandalonePluginWorkspaceAccess pluginWorkspaceAccess)`:
        *   This is the main entry point for integrating UI elements.
        *   Create an instance of `MarkupAction` (see below).
        *   Add the action to Oxygen's main toolbar and/or a menu (e.g., "Tools" menu).
        *   Example: `pluginWorkspaceAccess.addToolbarComponentsCustomizer(...)` or `pluginWorkspaceAccess.addMenuBarCustomizer(...)`.
        *   The action should be enabled only when an editor is open and has a selection.
    *   `applicationClosing()`: For cleanup.

3.  **`com.example.oxygen.ai.markup.MarkupAction.java`** (extends `javax.swing.AbstractAction`):
    *   Constructor: Takes `StandalonePluginWorkspaceAccess` as a parameter.
    *   `actionPerformed(ActionEvent e)`:
        *   Get the `WMainEditorPage` from `pluginWorkspaceAccess.getCurrentEditorAccess(StandalonePluginWorkspace.MAIN_EDITING_AREA)`.
        *   Check if it's a `WSXMLTextEditorPage` and if it `hasSelection()`.
        *   Get selected text: `wsxmlEditorPage.getSelectedText()`.
        *   **Retrieve AI Positron Enterprise Settings**:
            *   `OptionsStorage optionsStorage = pluginWorkspaceAccess.getOptionsStorage();`
            *   `String serviceURL = optionsStorage.getOption(OptionTags.AI_POSITRON_ENTERPRISE_CONNECTOR_URL, "http://127.0.0.1:5000/ai/");`
            *   `String apiKey = optionsStorage.getOption(OptionTags.AI_POSITRON_ENTERPRISE_API_KEY, "");`
            *   `String model = optionsStorage.getOption(OptionTags.AI_POSITRON_ENTERPRISE_MODEL, "gemma3:1b");`
            *   (Note: The exact `OptionTags` constants like `AI_POSITRON_ENTERPRISE_CONNECTOR_URL` need to be verified from Oxygen's API documentation, specifically within the `ro.sync.options.OptionTags` class or similar. If not directly available, alternative methods to access these specific AI Positron Enterprise settings might be needed, potentially by looking at how AI Positron itself accesses them or if there are dedicated APIs).
        *   **Load and Prepare Prompt**:
            *   Load `ref_markup_optV2.json` from the bundled resources (e.g., using `getClass().getResourceAsStream("/resources/ref_markup_optV2.json")`).
            *   Parse the JSON (using `org.json` or similar).
            *   Extract the `context` string. Replace `"${contextInfo}"` with an empty string or relevant dynamic info if any.
            *   Construct the `messages` array for the chat completions API:
                *   System message: The (modified) `context` from the JSON.
                *   User message: The `selectedText` from the editor.
        *   Call `LocalLlmApiService.callLLM()` in a background thread (e.g., `SwingWorker`) to avoid freezing the UI.
        *   On successful response from `SwingWorker.done()`:
            *   Open `MarkupPreviewDialog` with the original selected text, the AI suggestion, and a reference to the editor page.
        *   Handle errors (API call failure, no selection, etc.) by showing a message to the user (e.g., `JOptionPane.showMessageDialog`).

4.  **`com.example.oxygen.ai.markup.MarkupPreviewDialog.java`** (extends `javax.swing.JDialog`):
    *   Constructor: Takes `Frame owner`, `String originalText`, `String aiSuggestedMarkup`, `WSXMLTextEditorPage editorPage`.
    *   UI Layout (e.g., using `GridBagLayout` or `BorderLayout` with `JSplitPane`):
        *   Two `JEditorPane` or `RSyntaxTextArea` (if XML highlighting is desired and the library is included) components side-by-side. One for "Original Selection" (non-editable), one for "AI Suggestion" (potentially editable, or just for display).
        *   Set content type to "text/xml" for XML syntax highlighting if using `JEditorPane`.
        *   Populate them with `originalText` and `aiSuggestedMarkup`.
        *   Buttons: "Apply", "Copy", "Cancel".
    *   "Apply" button action:
        *   Get text from the "AI Suggestion" area.
        *   `editorPage.deleteSelection()`
        *   `editorPage.insert(aiSuggestedMarkup, editorPage.getSelectionStart())` (or `getCaretOffset()` if selection is deleted).
        *   Close the dialog.
    *   "Copy" button action:
        *   Get text from the "AI Suggestion" area.
        *   Copy to system clipboard: `Toolkit.getDefaultToolkit().getSystemClipboard().setContents(new StringSelection(aiMarkup), null);`
    *   "Cancel" button action: Close the dialog.
    *   Set modality, title, size, and make it visible.

5.  **`com.example.oxygen.ai.markup.LocalLlmApiService.java`**:
    *   Static method `callLLM(String serviceURL, String apiKey, String model, List<Map<String, String>> messages)`:
        *   Uses `java.net.http.HttpClient` (Java 11+).
        *   Construct the full API endpoint: `serviceURL + "chat/completions"`.
        *   Create JSON payload:
            ```json
            {
              "model": "model_from_settings",
              "messages": [
                {"role": "system", "content": "system_prompt_from_json"},
                {"role": "user", "content": "selected_text"}
              ],
              "max_tokens": 1500, // Or make configurable
              "temperature": 0.7  // Or make configurable
            }
            ```
            (Use `org.json.JSONObject` and `org.json.JSONArray` to build this).
        *   Create `HttpRequest` with "POST" method, "Authorization: Bearer " + `apiKey` header, "Content-Type: application/json" header, and the JSON payload.
        *   Send the request: `httpClient.send(request, HttpResponse.BodyHandlers.ofString())`.
        *   Parse the JSON response. Extract the AI's suggested content from `response.choices[0].message.content`.
        *   Handle HTTP errors (non-200 status codes) and network exceptions. Return `null` or throw a custom exception on error.

**Error Handling and User Feedback:**
*   Use `JOptionPane` for simple error messages or status updates.
*   Log exceptions to Oxygen's log or console.
*   Disable the action if AI Positron Enterprise settings are not configured for a custom service.
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-5" language="java">
// Conceptual snippet for MarkupAction.java - actionPerformed method
// @Override
// public void actionPerformed(ActionEvent e) {
//     if (pluginWorkspaceAccess == null) return;

//     WMainEditorPage currentPage = pluginWorkspaceAccess.getCurrentEditorAccess(StandalonePluginWorkspace.MAIN_EDITING_AREA);
//     if (currentPage instanceof WSXMLTextEditorPage) {
//         final WSXMLTextEditorPage editorPage = (WSXMLTextEditorPage) currentPage;
//         if (editorPage.hasSelection()) {
//             final String selectedText = editorPage.getSelectedText();

//             OptionsStorage optionsStorage = pluginWorkspaceAccess.getOptionsStorage();
//             // IMPORTANT: Verify these OptionTags from Oxygen's API documentation for AI Positron Enterprise settings.
//             // These are illustrative. The actual keys might be different or require a different access mechanism.
//             final String serviceBaseURL = optionsStorage.getOption("ai.positron.enterprise.connector.url", "http://127.0.0.1:5000/ai/");
//             final String apiKey = optionsStorage.getOption("ai.positron.enterprise.api.key", "");
//             final String modelName = optionsStorage.getOption("ai.positron.enterprise.model", "gemma3:1b"); // Default if not set

//             if (apiKey == null || apiKey.trim().isEmpty()) {
//                 JOptionPane.showMessageDialog(pluginWorkspaceAccess.getParentFrame(), 
//                                               "API Key for Custom AI Service is not configured in AI Positron Enterprise settings.", 
//                                               "Configuration Error", JOptionPane.ERROR_MESSAGE);
//                 return;
//             }
            
//             // Show a "Processing..." dialog or status update
//             // ...

//             SwingWorker<String, Void> worker = new SwingWorker<String, Void>() {
//                 @Override
//                 protected String doInBackground() throws Exception {
//                     // Load prompt from c:\Project\OCR\ref_markup_optV2.json (bundled in resources)
//                     String systemPromptContent = "";
//                     try (InputStream is = getClass().getResourceAsStream("/resources/ref_markup_optV2.json");
//                          BufferedReader reader = new BufferedReader(new InputStreamReader(is))) {
//                         StringBuilder jsonContent = new StringBuilder();
//                         String line;
//                         while ((line = reader.readLine()) != null) {
//                             jsonContent.append(line);
//                         }
//                         JSONArray promptConfigs = new JSONArray(jsonContent.toString());
//                         if (promptConfigs.length() > 0) {
//                             JSONObject mainConfig = promptConfigs.getJSONObject(0); // Assuming one main config
//                             systemPromptContent = mainConfig.getString("context");
//                             // Replace placeholder if necessary, e.g., remove ${contextInfo}
//                             systemPromptContent = systemPromptContent.replace("${contextInfo}", "").trim();
//                         }
//                     } catch (Exception ex) {
//                         // Log error and use a fallback or inform user
//                         System.err.println("Error loading prompt configuration: " + ex.getMessage());
//                         throw new Exception("Failed to load prompt configuration.", ex);
//                     }

//                     List<Map<String, String>> messages = new ArrayList<>();
//                     Map<String, String> systemMessage = new HashMap<>();
//                     systemMessage.put("role", "system");
//                     systemMessage.put("content", systemPromptContent);
//                     messages.add(systemMessage);

//                     Map<String, String> userMessage = new HashMap<>();
//                     userMessage.put("role", "user");
//                     userMessage.put("content", selectedText);
//                     messages.add(userMessage);
                    
//                     return LocalLlmApiService.callLLM(serviceBaseURL, apiKey, modelName, messages);
//                 }

//                 @Override
//                 protected void done() {
//                     // Hide "Processing..." dialog
//                     try {
//                         String aiSuggestion = get();
//                         if (aiSuggestion != null && !aiSuggestion.isEmpty()) {
//                             MarkupPreviewDialog dialog = new MarkupPreviewDialog(
//                                 (Frame) SwingUtilities.getWindowAncestor(pluginWorkspaceAccess.getParentFrame()), // Get proper Frame
//                                 selectedText, 
//                                 aiSuggestion, 
//                                 editorPage);
//                             dialog.setVisible(true);
//                         } else {
//                             JOptionPane.showMessageDialog(pluginWorkspaceAccess.getParentFrame(), "Received no suggestion from the AI service or an error occurred.", "AI Response", JOptionPane.WARNING_MESSAGE);
//                         }
//                     } catch (InterruptedException ex) {
//                         Thread.currentThread().interrupt(); // Restore interrupt status
//                         JOptionPane.showMessageDialog(pluginWorkspaceAccess.getParentFrame(), "Operation was interrupted.", "Error", JOptionPane.ERROR_MESSAGE);
//                     } catch (ExecutionException ex) {
//                         Throwable cause = ex.getCause();
//                         JOptionPane.showMessageDialog(pluginWorkspaceAccess.getParentFrame(), "Error calling AI service: " + cause.getMessage(), "API Error", JOptionPane.ERROR_MESSAGE);
//                         cause.printStackTrace(); // Log the full stack trace
//                     }
//                 }
//             };
//             worker.execute();

//         } else {
//             JOptionPane.showMessageDialog(pluginWorkspaceAccess.getParentFrame(), "Please select text in the editor first.", "No Selection", JOptionPane.INFORMATION_MESSAGE);
//         }
//     }
// }
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-6" language="markdown">
## 4. Interacting with AI Positron Settings and Prompt File

**AI Positron Enterprise Settings:**
The add-on will rely on the user configuring the "Custom AI service" via Oxygen's standard AI Positron Enterprise settings dialog:
*   **Address**: `PluginWorkspaceProvider.getPluginWorkspace().getOptionsStorage().getOption(OptionTags.AI_POSITRON_ENTERPRISE_CONNECTOR_URL, DEFAULT_URL)`
*   **API Key**: `PluginWorkspaceProvider.getPluginWorkspace().getOptionsStorage().getOption(OptionTags.AI_POSITRON_ENTERPRISE_API_KEY, "")`
*   **Model**: `PluginWorkspaceProvider.getPluginWorkspace().getOptionsStorage().getOption(OptionTags.AI_POSITRON_ENTERPRISE_MODEL, DEFAULT_MODEL)`

*(Verification of the exact `OptionTags` constants is crucial. These might be found in `ro.sync.options.OptionTags` or related classes in the Oxygen SDK. If these specific enterprise options are not exposed directly, a fallback could be to ask the user to set them via system properties or a custom settings dialog for the add-on itself, though leveraging existing Oxygen settings is preferred.)*

**Prompt Configuration (`ref_markup_optV2.json`):**
1.  Bundle `ref_markup_optV2.json` within the add-on's JAR, under a `resources` directory.
2.  In `MarkupAction.java`, load this file using `getClass().getResourceAsStream("/resources/ref_markup_optV2.json")`.
3.  Parse the JSON to extract the `context` string. The `examples` part of the JSON is for the LLM's fine-tuning or prompt engineering but isn't directly sent with each user request in this design (the LLM is assumed to be already capable or the `context` is comprehensive enough).
4.  The `context` string (which contains detailed instructions for the LLM) will serve as the "system" message. The selected text from the editor will be the "user" message.
5.  The placeholder `"${contextInfo}"` in the `context` string from `ref_markup_optV2.json` should be handled (e.g., replaced with an empty string or specific dynamic information if applicable, though for this use case, it seems it can be removed or ignored if the rest of the prompt is self-contained).
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-7" language="markdown">
## 5. UI Design Details

*   **Main Action Trigger (Toolbar/Menu):**
    *   A single action (button/menu item) labeled, for example, "AI Markup Selected Text".
    *   Icon: `icons/ai_markup_icon.png`.
    *   This action becomes enabled when an XML editor is active and has text selected.
    *   Invoking it initiates the process: gets selected text, fetches settings, prepares prompt, calls LLM (via `MarkupAction`).

*   **Markup Preview Dialog (`MarkupPreviewDialog.java`):**
    *   Modal `JDialog`.
    *   Title: "AI Markup Suggestion".
    *   Layout:
        *   A `JSplitPane` to show "Original Selection" and "AI Suggestion" side-by-side.
        *   Each pane contains a `JScrollPane` wrapping a `JEditorPane` (or `RSyntaxTextArea` for better XML highlighting if integrated).
            *   `JEditorPane originalPane = new JEditorPane("text/xml", originalText); originalPane.setEditable(false);`
            *   `JEditorPane suggestionPane = new JEditorPane("text/xml", aiSuggestedMarkup); suggestionPane.setEditable(true);` (Allowing edits before applying could be a feature).
        *   Labels above each pane: "Original Selection" and "AI Suggestion".
    *   Buttons at the bottom:
        *   **"Apply"**: Takes content from `suggestionPane`, replaces editor selection.
        *   **"Copy"**: Copies content from `suggestionPane` to clipboard.
        *   **"Cancel"**: Closes dialog.
    *   The dialog should be resizable.

*   **Configuration UI (Leveraging Oxygen):**
    *   The add-on will **not** provide its own UI for setting the LLM service URL, API key, or model.
    *   Users will configure these through Oxygen's existing "Plugins" > "Oxygen AI Positron Assistant Enterprise" > "AI Service Configuration" dialog by selecting "Custom AI service". The add-on reads these values as described in Section 4.
    *   The add-on could have a very minimal settings panel (via `ro.sync.exml.plugin.options.OptionsExtension`) only if absolutely necessary for options not covered by AI Positron settings (e.g., path to a *user-defined* prompt JSON, if not bundling `ref_markup_optV2.json`). For this plan, we assume `ref_markup_optV2.json` is bundled.
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-8" language="markdown">
## 6. Build and Deployment

1.  **Compile Java Code**: Use `javac` or an IDE (Eclipse, IntelliJ IDEA with Oxygen SDK configured).
    *   Ensure all custom classes are compiled.
2.  **Create JAR File (`custom-ai-markup.jar`)**:
    *   Package compiled `.class` files (e.g., `com/example/oxygen/ai/markup/*.class`).
    *   Include the `resources/ref_markup_optV2.json` inside the JAR at `/resources/ref_markup_optV2.json`.
    *   Include custom icons like `icons/ai_markup_icon.png` at `/icons/ai_markup_icon.png` if loaded via classpath, or ensure they are in the add-on's `icons` folder.
3.  **Prepare Add-on Directory Structure**:
    ```
    Oxygen-AI-Markup-Add-on/
    ├── addon.xml
    ├── plugin.xml
    ├── lib/
    │   ├── custom-ai-markup.jar
    │   └── json-java.jar  # (or other JSON lib)
    ├── icons/
    │   └── ai_markup_icon.png
    └── (license.txt, readme.html - optional)
    ```
4.  **Package Add-on**: Create a ZIP archive of the `Oxygen-AI-Markup-Add-on/` directory. This `.zip` file is the installable add-on.
5.  **Install in Oxygen**: Go to "Help" > "Install new add-ons..." and browse to the created `.zip` file. Restart Oxygen.
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-9" language="xml">
<!-- addon.xml -->
<addon id="com.example.oxygen.ai.markup.addon"
       name="AI Markup Assistant (Local LLM)"
       version="1.0.0"
       vendor="My Company"
       description="Integrates with a user-configured local LLM (via AI Positron Enterprise settings) for AI-powered XML markup suggestions based on a custom TEI prompt.">
    
    <script type="plugin" file="plugin.xml"/>
    
    <!-- Optional:
    <licenseDialog file="license.txt"/>
    <readmeDialog file="readme.html"/>
    -->
    
    <javaVersion min="11"/> <!-- Minimum Java version required -->
    <oxygenVersion min="27.0"/> <!-- Minimum Oxygen XML Editor version compatibility -->
</addon>
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-10" language="markdown">
## 7. Next Steps & Implementation Details

1.  **Verify AI Positron Option Keys**: Crucially, determine the exact `OptionTags` or method to retrieve the "Custom AI service" URL, API Key, and Model from Oxygen's AI Positron Enterprise settings. This might require inspecting the Oxygen SDK, documentation, or community forums. If direct access is problematic, a fallback would be custom options for the add-on.
2.  **Set up Java Development Environment**:
    *   JDK 11 or newer.
    *   IDE (Eclipse/IntelliJ) with Oxygen SDK correctly configured.
3.  **Implement Core Classes**:
    *   Start with `AIMarkupPluginExtension` and `AIMarkupWorkspaceAccessPluginExtension` to add the basic action.
    *   Develop `MarkupAction.java` to handle text selection and option retrieval.
    *   Implement `LocalLlmApiService.java` for robust communication with the Flask API.
4.  **Develop UI**: Create `MarkupPreviewDialog.java` with the side-by-side comparison.
5.  **Prompt Handling**: Ensure `ref_markup_optV2.json` is correctly bundled and parsed.
6.  **Threading**: Use `SwingWorker` for API calls to keep the UI responsive.
7.  **Error Handling**: Implement comprehensive error handling (network issues, API errors, JSON parsing errors, misconfiguration) with clear user feedback.
8.  **Testing**:
    *   Test with various selections in different XML documents.
    *   Test with different models configured in AI Positron settings.
    *   Test API key authentication.
    *   Test error conditions (API down, invalid API key, malformed LLM response).
9.  **Refinement**: Add progress indicators (e.g., a simple "Processing..." dialog) during API calls.
</VSCode.Cell>
</VSCode.Cell>
```

### c:\Project\OCR\localLlmWIntelGPUV2.ipynb

A new markdown cell will be added to the end of the notebook, linking to the `Oxygen-AI-Markup-add-on.ipynb` for the add-on development details.

````xml
<!-- filepath: c:\Project\OCR\localLlmWIntelGPUV2.ipynb -->
// ...existing code...
<VSCode.Cell id="9f621c9c" language="markdown">


## Summary

**Yes, you can load `gemma3:4b` (3.3GB) using MX250's shared memory access**, but expect:

- ✅ **Works**: Model will load and run
- ⚠️ **Slower**: 2-3x slower than VRAM-only models
- ⚠️ **System Impact**: Uses significant system RAM
- ✅ **Better Quality**: Better responses than smaller models

**Best Practice**: Use `gemma3:1b` for speed, `gemma3:4b` for quality when you can tolerate slower responses.
</VSCode.Cell>
<VSCode.Cell language="markdown">
# Oxygen XML Add-on Development Plan

For a detailed plan on developing an Oxygen XML Add-on that integrates with the local LLM service (Flask API) defined in this notebook, please refer to:

[./Oxygen-AI-Markup-add-on.ipynb](./Oxygen-AI-Markup-add-on.ipynb)

This add-on is designed to:
- Utilize the AI Positron Enterprise custom connector settings (Address, API Key, Model) from Oxygen.
- Allow users to select text in an XML document.
- Send the text with a predefined prompt (from `c:\Project\OCR\ref_markup_optV2.json`) to the local LLM.
- Provide a preview of the AI-generated markup and allow users to apply or copy it.
</VSCode.Cell>
</VSCode.Cell>
```

---

_**User**_

please follow  the above plan to implement it

---

_**Assistant**_

The plan to develop the Oxygen XML Add-on will be implemented by updating the content of the `Oxygen-AI-Markup-add-on.ipynb` notebook. The existing cells will be replaced with the detailed plan, including refined Java class descriptions, UI interactions, and specifics on using AI Positron Enterprise settings and the `ref_markup_optV2.json` prompt.

### [Oxygen-AI-Markup-add-on.ipynb](file:///c%3A/Project/OCR/Oxygen-AI-Markup-add-on.ipynb)

The content of this notebook will be replaced with a detailed development plan. This includes updating the introductory cells and the nested cells within the main XML cell to provide a comprehensive guide for creating the add-on. Cell IDs for existing top-level cells will be maintained. Nested cells within the XML structure will be assigned IDs and populated with the detailed plan.

````xml
<VSCode.Cell id="a60f1728" language="python">
# This cell can be removed or used for Python-based helper scripts for add-on development if needed.
# For now, it will be left empty as the primary focus is the Java add-on.
</VSCode.Cell>
<VSCode.Cell id="96643969" language="markdown">
This notebook details the development plan for an Oxygen XML Add-on. The add-on will integrate with your local LLM service via its Flask API, utilizing Oxygen's AI Positron Assistant Enterprise settings for configuration. It will enable users to select text, get AI-powered markup suggestions based on a custom prompt (like `c:\Project\OCR\ref_markup_optV2.json`), preview these suggestions, and then apply or copy them.
</VSCode.Cell>
<VSCode.Cell id="f1061c43" language="xml">
<VSCode.Cell id="f1061c43-cell-0" language="markdown">
# Oxygen XML Add-on for AI-Powered Markup

This notebook outlines the development of an Oxygen XML Add-on that integrates with a local LLM service (via Flask API) to provide AI-powered markup capabilities. The add-on will allow users to:

1.  Trigger an action (e.g., via toolbar button or menu item) when text is selected in an XML editor.
2.  Use a predefined prompt structure (from a configuration file like `c:\Project\OCR\ref_markup_optV2.json`) combined with the selected text.
3.  Send this information to the local LLM service, leveraging settings from Oxygen's AI Positron Enterprise configuration (service address, API key, model).
4.  Display a dialog showing the original selected text alongside the LLM's suggested XML markup.
5.  Allow the user to:
    *   **Apply**: Replace the selected text in the editor with the AI-generated markup.
    *   **Copy**: Copy the AI-generated markup to the clipboard.
    *   **Cancel**: Close the dialog without making changes.

This development will follow Oxygen's guidelines for creating add-ons and plugins.

**References:**
*   [Extending Oxygen XML Editor](https://www.oxygenxml.com/doc/versions/27.1/ug-editor/topics/extending-oxygen.html)
*   [Extend Oxygen XML Editor with Plugins](https://www.oxygenxml.com/doc/versions/27.1/ug-editor/topics/extend-oxygen-with-plugins.html)
*   [Packing and Deploying Plugins as Add-ons](https://www.oxygenxml.com/doc/versions/27.1/ug-editor/topics/packing-and-deploying-plugins-as-addons.html)
*   [Oxygen XML Editor Developer Guide](https://www.oxygenxml.com/doc/versions/27.1/ug-editor/dev_guide/introduction-dev-guide.html)
*   [AI Positron Custom Connector](https://www.oxygenxml.com/doc/ug-addons/topics/ai-positron-custom-connector.html) (for understanding how AI Positron settings are structured, though we directly call our Flask API)
*   `c:\Project\OCR\ref_markup_optV2.json` (for prompt structure)
*   `c:\Project\OCR\localLlmWIntelGPUV2.ipynb` (for the local LLM Flask API details)
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-1" language="markdown">
## 1. Add-on Structure

An Oxygen XML Add-on typically has the following structure:

```
Oxygen-AI-Markup-Add-on/
├── addon.xml                 # Add-on descriptor
├── plugin.xml                # Plugin descriptor (core logic)
├── lib/                      # Folder for JAR dependencies
│   └── custom-ai-markup.jar  # Our plugin's compiled JAR
│   └── json-java.jar         # Example: org.json library for JSON processing
├── icons/                    # Folder for custom icons
│   └── ai_markup_icon.png    # Icon for the toolbar/menu action
└── resources/                # Folder for other resources
    └── ref_markup_optV2.json # Bundled prompt configuration
```

*   **`addon.xml`**: Describes the add-on for Oxygen's add-on manager.
*   **`plugin.xml`**: Defines the plugin's extensions, actions, and entry points.
*   **`lib/custom-ai-markup.jar`**: The compiled Java code containing the add-on's logic.
*   **`lib/json-java.jar`**: Dependency for parsing and creating JSON (or similar, like Jackson/Gson).
*   **`resources/ref_markup_optV2.json`**: The prompt configuration file, bundled with the add-on.
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-2" language="markdown">
## 2. `plugin.xml` Configuration

This file is the heart of the plugin, defining how it integrates with Oxygen.

Key sections:
*   **Plugin Information**: ID, name, version, description, vendor.
*   **Extension Points**:
    *   `ro.sync.exml.plugin.workspace.WorkspaceAccessPluginExtension`: To add custom actions to menus/toolbars and access workspace features.
*   **Libraries**: Specifies the JAR file(s) containing the plugin code and dependencies.
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-3" language="xml">
<!-- plugin.xml example -->
<!DOCTYPE plugin SYSTEM "../plugin.dtd">
<plugin
    id="com.example.oxygen.ai.markup"
    name="AI Markup Assistant (Local LLM)"
    description="Provides AI-powered markup suggestions using a configured local LLM via Flask API."
    version="1.0.0"
    vendor="My Company"
    class="com.example.oxygen.ai.markup.AIMarkupPluginExtension">

    <runtime>
        <library name="lib/custom-ai-markup.jar"/>
        <library name="lib/json-java.jar"/> <!-- Example: org.json for JSON processing -->
    </runtime>

    <extension type="WorkspaceAccessPluginExtension" class="com.example.oxygen.ai.markup.AIMarkupWorkspaceAccessPluginExtension"/>
    
</plugin>
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-4" language="markdown">
## 3. Java Implementation Outline

The core logic will be implemented in Java.

**Project Setup:**
*   Create a Java project.
*   Add `oxygen.jar` (from Oxygen installation directory) and other necessary Oxygen SDK JARs to the project's build path.
*   Add `json-java.jar` (or chosen JSON library) to the project's build path and include it in the `lib` folder of the add-on.

**Key Java Classes:**

1.  **`com.example.oxygen.ai.markup.AIMarkupPluginExtension.java`**:
    *   Implements `ro.sync.exml.plugin.PluginExtension`.
    *   `init(PluginDescriptor descriptor)`: Called when the plugin is initialized.
    *   `applicationClosing()`: Called when Oxygen is closing, for cleanup if needed.

2.  **`com.example.oxygen.ai.markup.AIMarkupWorkspaceAccessPluginExtension.java`**:
    *   Implements `ro.sync.exml.plugin.workspace.WorkspaceAccessPluginExtension`.
    *   `applicationStarted(StandalonePluginWorkspaceAccess pluginWorkspaceAccess)`:
        *   This is the main entry point for integrating UI elements.
        *   Create an instance of `MarkupAction` (see below).
        *   Add the action to Oxygen's main toolbar and/or a menu (e.g., "Tools" menu).
        *   Example: `pluginWorkspaceAccess.addToolbarComponentsCustomizer(...)` or `pluginWorkspaceAccess.addMenuBarCustomizer(...)`.
        *   The action should be enabled only when an editor is open and has a selection.
    *   `applicationClosing()`: For cleanup.

3.  **`com.example.oxygen.ai.markup.MarkupAction.java`** (extends `javax.swing.AbstractAction`):
    *   Constructor: Takes `StandalonePluginWorkspaceAccess` as a parameter.
    *   `actionPerformed(ActionEvent e)`:
        *   Get the `WMainEditorPage` from `pluginWorkspaceAccess.getCurrentEditorAccess(StandalonePluginWorkspace.MAIN_EDITING_AREA)`.
        *   Check if it's a `WSXMLTextEditorPage` and if it `hasSelection()`.
        *   Get selected text: `wsxmlEditorPage.getSelectedText()`.
        *   **Retrieve AI Positron Enterprise Settings**:
            *   `OptionsStorage optionsStorage = pluginWorkspaceAccess.getOptionsStorage();`
            *   `String serviceURL = optionsStorage.getOption(OptionTags.AI_POSITRON_ENTERPRISE_CONNECTOR_URL, "http://127.0.0.1:5000/ai/");`
            *   `String apiKey = optionsStorage.getOption(OptionTags.AI_POSITRON_ENTERPRISE_API_KEY, "");`
            *   `String model = optionsStorage.getOption(OptionTags.AI_POSITRON_ENTERPRISE_MODEL, "gemma3:1b");`
            *   (Note: The exact `OptionTags` constants like `AI_POSITRON_ENTERPRISE_CONNECTOR_URL` need to be verified from Oxygen's API documentation, specifically within the `ro.sync.options.OptionTags` class or similar. If not directly available, alternative methods to access these specific AI Positron Enterprise settings might be needed, potentially by looking at how AI Positron itself accesses them or if there are dedicated APIs).
        *   **Load and Prepare Prompt**:
            *   Load `ref_markup_optV2.json` from the bundled resources (e.g., using `getClass().getResourceAsStream("/resources/ref_markup_optV2.json")`).
            *   Parse the JSON (using `org.json` or similar).
            *   Extract the `context` string. Replace `"${contextInfo}"` with an empty string or relevant dynamic info if any.
            *   Construct the `messages` array for the chat completions API:
                *   System message: The (modified) `context` from the JSON.
                *   User message: The `selectedText` from the editor.
        *   Call `LocalLlmApiService.callLLM()` in a background thread (e.g., `SwingWorker`) to avoid freezing the UI.
        *   On successful response from `SwingWorker.done()`:
            *   Open `MarkupPreviewDialog` with the original selected text, the AI suggestion, and a reference to the editor page.
        *   Handle errors (API call failure, no selection, etc.) by showing a message to the user (e.g., `JOptionPane.showMessageDialog`).

4.  **`com.example.oxygen.ai.markup.MarkupPreviewDialog.java`** (extends `javax.swing.JDialog`):
    *   Constructor: Takes `Frame owner`, `String originalText`, `String aiSuggestedMarkup`, `WSXMLTextEditorPage editorPage`.
    *   UI Layout (e.g., using `GridBagLayout` or `BorderLayout` with `JSplitPane`):
        *   Two `JEditorPane` or `RSyntaxTextArea` (if XML highlighting is desired and the library is included) components side-by-side. One for "Original Selection" (non-editable), one for "AI Suggestion" (potentially editable, or just for display).
        *   Set content type to "text/xml" for XML syntax highlighting if using `JEditorPane`.
        *   Populate them with `originalText` and `aiSuggestedMarkup`.
        *   Buttons: "Apply", "Copy", "Cancel".
    *   "Apply" button action:
        *   Get text from the "AI Suggestion" area.
        *   `editorPage.deleteSelection()`
        *   `editorPage.insert(aiSuggestedMarkup, editorPage.getSelectionStart())` (or `getCaretOffset()` if selection is deleted).
        *   Close the dialog.
    *   "Copy" button action:
        *   Get text from the "AI Suggestion" area.
        *   Copy to system clipboard: `Toolkit.getDefaultToolkit().getSystemClipboard().setContents(new StringSelection(aiMarkup), null);`
    *   "Cancel" button action: Close the dialog.
    *   Set modality, title, size, and make it visible.

5.  **`com.example.oxygen.ai.markup.LocalLlmApiService.java`**:
    *   Static method `callLLM(String serviceURL, String apiKey, String model, List<Map<String, String>> messages)`:
        *   Uses `java.net.http.HttpClient` (Java 11+).
        *   Construct the full API endpoint: `serviceURL + "chat/completions"`.
        *   Create JSON payload:
            ```json
            {
              "model": "model_from_settings",
              "messages": [
                {"role": "system", "content": "system_prompt_from_json"},
                {"role": "user", "content": "selected_text"}
              ],
              "max_tokens": 1500, // Or make configurable
              "temperature": 0.7  // Or make configurable
            }
            ```
            (Use `org.json.JSONObject` and `org.json.JSONArray` to build this).
        *   Create `HttpRequest` with "POST" method, "Authorization: Bearer " + `apiKey` header, "Content-Type: application/json" header, and the JSON payload.
        *   Send the request: `httpClient.send(request, HttpResponse.BodyHandlers.ofString())`.
        *   Parse the JSON response. Extract the AI's suggested content from `response.choices[0].message.content`.
        *   Handle HTTP errors (non-200 status codes) and network exceptions. Return `null` or throw a custom exception on error.

**Error Handling and User Feedback:**
*   Use `JOptionPane` for simple error messages or status updates.
*   Log exceptions to Oxygen's log or console.
*   Disable the action if AI Positron Enterprise settings are not configured for a custom service.
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-5" language="java">
// Conceptual snippet for MarkupAction.java - actionPerformed method
// @Override
// public void actionPerformed(ActionEvent e) {
//     if (pluginWorkspaceAccess == null) return;

//     WMainEditorPage currentPage = pluginWorkspaceAccess.getCurrentEditorAccess(StandalonePluginWorkspace.MAIN_EDITING_AREA);
//     if (currentPage instanceof WSXMLTextEditorPage) {
//         final WSXMLTextEditorPage editorPage = (WSXMLTextEditorPage) currentPage;
//         if (editorPage.hasSelection()) {
//             final String selectedText = editorPage.getSelectedText();

//             OptionsStorage optionsStorage = pluginWorkspaceAccess.getOptionsStorage();
//             // IMPORTANT: Verify these OptionTags from Oxygen's API documentation for AI Positron Enterprise settings.
//             // These are illustrative. The actual keys might be different or require a different access mechanism.
//             final String serviceBaseURL = optionsStorage.getOption("ai.positron.enterprise.connector.url", "http://127.0.0.1:5000/ai/");
//             final String apiKey = optionsStorage.getOption("ai.positron.enterprise.api.key", "");
//             final String modelName = optionsStorage.getOption("ai.positron.enterprise.model", "gemma3:1b"); // Default if not set

//             if (apiKey == null || apiKey.trim().isEmpty()) {
//                 JOptionPane.showMessageDialog(pluginWorkspaceAccess.getParentFrame(), 
//                                               "API Key for Custom AI Service is not configured in AI Positron Enterprise settings.", 
//                                               "Configuration Error", JOptionPane.ERROR_MESSAGE);
//                 return;
//             }
            
//             // Show a "Processing..." dialog or status update
//             // ...

//             SwingWorker<String, Void> worker = new SwingWorker<String, Void>() {
//                 @Override
//                 protected String doInBackground() throws Exception {
//                     // Load prompt from c:\Project\OCR\ref_markup_optV2.json (bundled in resources)
//                     String systemPromptContent = "";
//                     try (InputStream is = getClass().getResourceAsStream("/resources/ref_markup_optV2.json");
//                          BufferedReader reader = new BufferedReader(new InputStreamReader(is))) {
//                         StringBuilder jsonContent = new StringBuilder();
//                         String line;
//                         while ((line = reader.readLine()) != null) {
//                             jsonContent.append(line);
//                         }
//                         JSONArray promptConfigs = new JSONArray(jsonContent.toString());
//                         if (promptConfigs.length() > 0) {
//                             JSONObject mainConfig = promptConfigs.getJSONObject(0); // Assuming one main config
//                             systemPromptContent = mainConfig.getString("context");
//                             // Replace placeholder if necessary, e.g., remove ${contextInfo}
//                             systemPromptContent = systemPromptContent.replace("${contextInfo}", "").trim();
//                         }
//                     } catch (Exception ex) {
//                         // Log error and use a fallback or inform user
//                         System.err.println("Error loading prompt configuration: " + ex.getMessage());
//                         throw new Exception("Failed to load prompt configuration.", ex);
//                     }

//                     List<Map<String, String>> messages = new ArrayList<>();
//                     Map<String, String> systemMessage = new HashMap<>();
//                     systemMessage.put("role", "system");
//                     systemMessage.put("content", systemPromptContent);
//                     messages.add(systemMessage);

//                     Map<String, String> userMessage = new HashMap<>();
//                     userMessage.put("role", "user");
//                     userMessage.put("content", selectedText);
//                     messages.add(userMessage);
                    
//                     return LocalLlmApiService.callLLM(serviceBaseURL, apiKey, modelName, messages);
//                 }

//                 @Override
//                 protected void done() {
//                     // Hide "Processing..." dialog
//                     try {
//                         String aiSuggestion = get();
//                         if (aiSuggestion != null && !aiSuggestion.isEmpty()) {
//                             MarkupPreviewDialog dialog = new MarkupPreviewDialog(
//                                 (Frame) SwingUtilities.getWindowAncestor(pluginWorkspaceAccess.getParentFrame()), // Get proper Frame
//                                 selectedText, 
//                                 aiSuggestion, 
//                                 editorPage);
//                             dialog.setVisible(true);
//                         } else {
//                             JOptionPane.showMessageDialog(pluginWorkspaceAccess.getParentFrame(), "Received no suggestion from the AI service or an error occurred.", "AI Response", JOptionPane.WARNING_MESSAGE);
//                         }
//                     } catch (InterruptedException ex) {
//                         Thread.currentThread().interrupt(); // Restore interrupt status
//                         JOptionPane.showMessageDialog(pluginWorkspaceAccess.getParentFrame(), "Operation was interrupted.", "Error", JOptionPane.ERROR_MESSAGE);
//                     } catch (ExecutionException ex) {
//                         Throwable cause = ex.getCause();
//                         JOptionPane.showMessageDialog(pluginWorkspaceAccess.getParentFrame(), "Error calling AI service: " + cause.getMessage(), "API Error", JOptionPane.ERROR_MESSAGE);
//                         cause.printStackTrace(); // Log the full stack trace
//                     }
//                 }
//             };
//             worker.execute();

//         } else {
//             JOptionPane.showMessageDialog(pluginWorkspaceAccess.getParentFrame(), "Please select text in the editor first.", "No Selection", JOptionPane.INFORMATION_MESSAGE);
//         }
//     }
// }
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-6" language="markdown">
## 4. Interacting with AI Positron Settings and Prompt File

**AI Positron Enterprise Settings:**
The add-on will rely on the user configuring the "Custom AI service" via Oxygen's standard AI Positron Enterprise settings dialog:
*   **Address**: `PluginWorkspaceProvider.getPluginWorkspace().getOptionsStorage().getOption(OptionTags.AI_POSITRON_ENTERPRISE_CONNECTOR_URL, DEFAULT_URL)`
*   **API Key**: `PluginWorkspaceProvider.getPluginWorkspace().getOptionsStorage().getOption(OptionTags.AI_POSITRON_ENTERPRISE_API_KEY, "")`
*   **Model**: `PluginWorkspaceProvider.getPluginWorkspace().getOptionsStorage().getOption(OptionTags.AI_POSITRON_ENTERPRISE_MODEL, DEFAULT_MODEL)`

*(Verification of the exact `OptionTags` constants is crucial. These might be found in `ro.sync.options.OptionTags` or related classes in the Oxygen SDK. If these specific enterprise options are not exposed directly, a fallback could be to ask the user to set them via system properties or a custom settings dialog for the add-on itself, though leveraging existing Oxygen settings is preferred.)*

**Prompt Configuration (`ref_markup_optV2.json`):**
1.  Bundle `ref_markup_optV2.json` within the add-on's JAR, under a `resources` directory.
2.  In `MarkupAction.java`, load this file using `getClass().getResourceAsStream("/resources/ref_markup_optV2.json")`.
3.  Parse the JSON to extract the `context` string. The `examples` part of the JSON is for the LLM's fine-tuning or prompt engineering but isn't directly sent with each user request in this design (the LLM is assumed to be already capable or the `context` is comprehensive enough).
4.  The `context` string (which contains detailed instructions for the LLM) will serve as the "system" message. The selected text from the editor will be the "user" message.
5.  The placeholder `"${contextInfo}"` in the `context` string from `ref_markup_optV2.json` should be handled (e.g., replaced with an empty string or specific dynamic information if applicable, though for this use case, it seems it can be removed or ignored if the rest of the prompt is self-contained).
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-7" language="markdown">
## 5. UI Design Details

*   **Main Action Trigger (Toolbar/Menu):**
    *   A single action (button/menu item) labeled, for example, "AI Markup Selected Text".
    *   Icon: `icons/ai_markup_icon.png`.
    *   This action becomes enabled when an XML editor is active and has text selected.
    *   Invoking it initiates the process: gets selected text, fetches settings, prepares prompt, calls LLM (via `MarkupAction`).

*   **Markup Preview Dialog (`MarkupPreviewDialog.java`):**
    *   Modal `JDialog`.
    *   Title: "AI Markup Suggestion".
    *   Layout:
        *   A `JSplitPane` to show "Original Selection" and "AI Suggestion" side-by-side.
        *   Each pane contains a `JScrollPane` wrapping a `JEditorPane` (or `RSyntaxTextArea` for better XML highlighting if integrated).
            *   `JEditorPane originalPane = new JEditorPane("text/xml", originalText); originalPane.setEditable(false);`
            *   `JEditorPane suggestionPane = new JEditorPane("text/xml", aiSuggestedMarkup); suggestionPane.setEditable(true);` (Allowing edits before applying could be a feature).
        *   Labels above each pane: "Original Selection" and "AI Suggestion".
    *   Buttons at the bottom:
        *   **"Apply"**: Takes content from `suggestionPane`, replaces editor selection.
        *   **"Copy"**: Copies content from `suggestionPane` to clipboard.
        *   **"Cancel"**: Closes dialog.
    *   The dialog should be resizable.

*   **Configuration UI (Leveraging Oxygen):**
    *   The add-on will **not** provide its own UI for setting the LLM service URL, API key, or model.
    *   Users will configure these through Oxygen's existing "Plugins" > "Oxygen AI Positron Assistant Enterprise" > "AI Service Configuration" dialog by selecting "Custom AI service". The add-on reads these values as described in Section 4.
    *   The add-on could have a very minimal settings panel (via `ro.sync.exml.plugin.options.OptionsExtension`) only if absolutely necessary for options not covered by AI Positron settings (e.g., path to a *user-defined* prompt JSON, if not bundling `ref_markup_optV2.json`). For this plan, we assume `ref_markup_optV2.json` is bundled.
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-8" language="markdown">
## 6. Build and Deployment

1.  **Compile Java Code**: Use `javac` or an IDE (Eclipse, IntelliJ IDEA with Oxygen SDK configured).
    *   Ensure all custom classes are compiled.
2.  **Create JAR File (`custom-ai-markup.jar`)**:
    *   Package compiled `.class` files (e.g., `com/example/oxygen/ai/markup/*.class`).
    *   Include the `resources/ref_markup_optV2.json` inside the JAR at `/resources/ref_markup_optV2.json`.
    *   Include custom icons like `icons/ai_markup_icon.png` at `/icons/ai_markup_icon.png` if loaded via classpath, or ensure they are in the add-on's `icons` folder.
3.  **Prepare Add-on Directory Structure**:
    ```
    Oxygen-AI-Markup-Add-on/
    ├── addon.xml
    ├── plugin.xml
    ├── lib/
    │   ├── custom-ai-markup.jar
    │   └── json-java.jar  # (or other JSON lib)
    ├── icons/
    │   └── ai_markup_icon.png
    └── (license.txt, readme.html - optional)
    ```
4.  **Package Add-on**: Create a ZIP archive of the `Oxygen-AI-Markup-Add-on/` directory. This `.zip` file is the installable add-on.
5.  **Install in Oxygen**: Go to "Help" > "Install new add-ons..." and browse to the created `.zip` file. Restart Oxygen.
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-9" language="xml">
<!-- addon.xml -->
<addon id="com.example.oxygen.ai.markup.addon"
       name="AI Markup Assistant (Local LLM)"
       version="1.0.0"
       vendor="My Company"
       description="Integrates with a user-configured local LLM (via AI Positron Enterprise settings) for AI-powered XML markup suggestions based on a custom TEI prompt.">
    
    <script type="plugin" file="plugin.xml"/>
    
    <!-- Optional:
    <licenseDialog file="license.txt"/>
    <readmeDialog file="readme.html"/>
    -->
    
    <javaVersion min="11"/> <!-- Minimum Java version required -->
    <oxygenVersion min="27.0"/> <!-- Minimum Oxygen XML Editor version compatibility -->
</addon>
</VSCode.Cell>
<VSCode.Cell id="f1061c43-cell-10" language="markdown">
## 7. Next Steps & Implementation Details

1.  **Verify AI Positron Option Keys**: Crucially, determine the exact `OptionTags` or method to retrieve the "Custom AI service" URL, API Key, and Model from Oxygen's AI Positron Enterprise settings. This might require inspecting the Oxygen SDK, documentation, or community forums. If direct access is problematic, a fallback would be custom options for the add-on.
2.  **Set up Java Development Environment**:
    *   JDK 11 or newer.
    *   IDE (Eclipse/IntelliJ) with Oxygen SDK correctly configured.
3.  **Implement Core Classes**:
    *   Start with `AIMarkupPluginExtension` and `AIMarkupWorkspaceAccessPluginExtension` to add the basic action.
    *   Develop `MarkupAction.java` to handle text selection and option retrieval.
    *   Implement `LocalLlmApiService.java` for robust communication with the Flask API.
4.  **Develop UI**: Create `MarkupPreviewDialog.java` with the side-by-side comparison.
5.  **Prompt Handling**: Ensure `ref_markup_optV2.json` is correctly bundled and parsed.
6.  **Threading**: Use `SwingWorker` for API calls to keep the UI responsive.
7.  **Error Handling**: Implement comprehensive error handling (network issues, API errors, JSON parsing errors, misconfiguration) with clear user feedback.
8.  **Testing**:
    *   Test with various selections in different XML documents.
    *   Test with different models configured in AI Positron settings.
    *   Test API key authentication.
    *   Test error conditions (API down, invalid API key, malformed LLM response).
9.  **Refinement**: Add progress indicators (e.g., a simple "Processing..." dialog) during API calls.
</VSCode.Cell>
</VSCode.Cell>
```

---

